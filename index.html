<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Admin - Saisie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div class="max-w-2xl mx-auto">
        <div id="sync-status" class="text-center text-xs mb-4 text-slate-500 italic">Initialisation...</div>

        <h1 class="text-2xl font-black text-slate-800 mb-6 text-center">TICKET SYNC ADMIN</h1>

        <div class="space-y-6">
            <!-- Boutique -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold mb-4 flex items-center gap-2 text-blue-600">ğŸ  Boutique</h2>
                <div class="grid gap-3">
                    <input type="text" id="store-name" oninput="window.saveData()" placeholder="Nom du magasin" class="w-full p-2 border rounded-lg">
                    <input type="text" id="store-logo" oninput="window.saveData()" placeholder="URL Logo" class="w-full p-2 border rounded-lg text-sm">
                    <textarea id="store-address" oninput="window.saveData()" placeholder="Adresse & Tel" class="w-full p-2 border rounded-lg h-20 text-sm"></textarea>
                </div>
            </div>

            <!-- Commande -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="font-bold mb-4 flex items-center gap-2 text-purple-600">ğŸ« Commande</h2>
                <div class="flex gap-2">
                    <input type="text" id="order-prefix" oninput="window.saveData()" placeholder="PrÃ©fixe" class="w-1/3 p-2 border rounded-lg">
                    <input type="number" id="order-num" oninput="window.saveData()" placeholder="NÂ°" class="w-2/3 p-2 border rounded-lg">
                </div>
            </div>

            <!-- Articles -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold">ğŸ›’ Articles (TTC)</h2>
                    <button onclick="window.addItem()" class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-bold">+ Ajouter</button>
                </div>
                <div id="items-list" class="space-y-2"></div>
            </div>

            <div class="text-center pt-4">
                <a href="view.html" target="_blank" class="inline-block bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-black">
                    ğŸ‘ï¸ Ouvrir l'Afficheur de Ticket
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let state = {
            storeName: "", storeLogo: "", storeAddress: "",
            prefix: "CMD-", orderNumber: 1,
            items: [{ id: Date.now(), name: "Article", priceTTC: 0, tva: "B" }]
        };

        let user = null;
        let isSyncing = false;

        // Fonction d'initialisation de l'auth
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
                document.getElementById('sync-status').innerText = "âŒ Erreur Auth";
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                // Chemin Ã  6 segments : artifacts / appId / public / data / config / main
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main');
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        isSyncing = true;
                        state = snap.data();
                        updateFields();
                        renderItems();
                        document.getElementById('sync-status').innerText = "â˜ï¸ Synchro active";
                        isSyncing = false;
                    }
                }, (error) => {
                    console.error("Snapshot error:", error);
                    document.getElementById('sync-status').innerText = "âŒ Erreur de lecture";
                });
            }
        });

        function updateFields() {
            document.getElementById('store-name').value = state.storeName || "";
            document.getElementById('store-logo').value = state.storeLogo || "";
            document.getElementById('store-address').value = state.storeAddress || "";
            document.getElementById('order-prefix').value = state.prefix || "";
            document.getElementById('order-num').value = state.orderNumber || 0;
        }

        function renderItems() {
            const list = document.getElementById('items-list');
            if (!list) return;
            list.innerHTML = '';
            state.items.forEach((item, i) => {
                const row = document.createElement('div');
                row.className = "flex gap-2 items-center bg-slate-50 p-2 rounded border";
                row.innerHTML = `
                    <input type="text" value="${item.name}" oninput="window.updateItem(${i}, 'name', this.value)" class="flex-1 p-1 text-sm border rounded">
                    <input type="number" step="0.01" value="${item.priceTTC}" oninput="window.updateItem(${i}, 'priceTTC', parseFloat(this.value))" class="w-20 p-1 text-sm border rounded text-right">
                    <select onchange="window.updateItem(${i}, 'tva', this.value)" class="p-1 text-xs border rounded">
                        <option value="A" ${item.tva=='A'?'selected':''}>20%</option>
                        <option value="B" ${item.tva=='B'?'selected':''}>10%</option>
                    </select>
                    <button onclick="window.deleteItem(${i})" class="text-red-500 px-1">âœ•</button>
                `;
                list.appendChild(row);
            });
        }

        window.saveData = async () => {
            if (!user || isSyncing) return;
            state.storeName = document.getElementById('store-name').value;
            state.storeLogo = document.getElementById('store-logo').value;
            state.storeAddress = document.getElementById('store-address').value;
            state.prefix = document.getElementById('order-prefix').value;
            state.orderNumber = parseInt(document.getElementById('order-num').value) || 0;
            
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'main');
            try {
                await setDoc(docRef, state);
            } catch (err) {
                console.error("Save error:", err);
            }
        };

        window.addItem = () => { 
            state.items.push({id:Date.now(), name:"", priceTTC:0, tva:"A"}); 
            window.saveData(); 
            renderItems(); 
        };

        window.deleteItem = (i) => { 
            state.items.splice(i, 1); 
            window.saveData(); 
            renderItems(); 
        };

        window.updateItem = (i, f, v) => { 
            state.items[i][f] = v; 
            window.saveData(); 
        };

        // Lancement
        initAuth();
    </script>
</body>
</html>
