<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Sync Pro - Saisie TTC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        .ticket-receipt {
            width: 53mm;
            background: white;
            padding: 4mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Courier Prime', monospace;
            font-size: 10px;
            color: black;
            line-height: 1.2;
            cursor: pointer;
        }

        .ticket-container {
            display: flex;
            justify-content: center;
            background: #e2e8f0;
            padding: 20px;
            min-height: 500px;
        }

        @media print {
            body * { visibility: hidden; }
            #receipt-to-print, #receipt-to-print * { visibility: visible; }
            #receipt-to-print { position: absolute; left: 0; top: 0; box-shadow: none; width: 53mm; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4">
        <!-- Status Bar -->
        <div id="sync-status" class="text-center text-xs mb-2 text-slate-500 italic">Connexion au cloud...</div>

        <!-- Navigation -->
        <nav class="flex space-x-2 mb-6 bg-white p-1 rounded-xl shadow-sm border border-slate-200">
            <button onclick="switchPage('config')" id="btn-config" class="flex-1 py-3 px-4 rounded-lg transition-all bg-blue-600 text-white font-bold shadow-md">
                ‚öôÔ∏è Configurer
            </button>
            <button onclick="switchPage('view')" id="btn-view" class="flex-1 py-3 px-4 rounded-lg transition-all text-slate-600 font-bold hover:bg-slate-50">
                üìÑ Voir Ticket
            </button>
        </nav>

        <!-- Page Configuration -->
        <section id="page-config" class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-100 p-2 rounded-lg text-blue-600">üè†</span> Boutique
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="store-name" oninput="saveData()" placeholder="Nom de la boutique" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                    <input type="text" id="store-logo" oninput="saveData()" placeholder="URL Logo (https://...)" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                    <textarea id="store-address" oninput="saveData()" placeholder="Adresse / Tel" class="col-span-full w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none h-20"></textarea>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span class="bg-purple-100 p-2 rounded-lg text-purple-600">üé´</span> Commande
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="order-prefix" oninput="saveData()" placeholder="Pr√©fixe" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                    <input type="number" id="order-num" oninput="saveData()" placeholder="Num√©ro" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none">
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">üõí Articles (Saisie TTC)</h2>
                    <button onclick="addItem()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-green-700">
                        + Ajouter
                    </button>
                </div>
                <div id="items-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- Page Visualisation -->
        <section id="page-view" class="hidden">
            <div class="flex flex-col items-center gap-4 mb-6">
                <button onclick="openPrintWindow()" class="bg-slate-800 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-black transition-colors">
                    üöÄ Ouvrir Page Impression Seule
                </button>
                <p class="text-xs text-slate-500 italic">Ou clique directement sur le ticket ci-dessous</p>
            </div>
            
            <div class="ticket-container">
                <div id="receipt-to-print" class="ticket-receipt" onclick="openPrintWindow()">
                    <!-- Contenu g√©n√©r√© en JS -->
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ticket-app-unique';

        let state = {
            storeName: "Ma Boutique",
            storeLogo: "",
            storeAddress: "123 Rue du Commerce",
            prefix: "CMD-",
            orderNumber: 1,
            items: [{ id: Date.now(), name: "Caf√©", priceTTC: 2.50, tva: "B" }]
        };

        let user = null;
        let isUpdatingFromSync = false;

        async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) setupRealtimeSync();
                });
            } catch (err) { console.error(err); }
        }

        function setupRealtimeSync() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ticketConfig');
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    isUpdatingFromSync = true;
                    state = snap.data();
                    updateUI();
                    renderReceipt();
                    document.getElementById('sync-status').innerText = "‚òÅÔ∏è Synchronis√©";
                    isUpdatingFromSync = false;
                } else {
                    saveData();
                }
            }, (err) => {
                document.getElementById('sync-status').innerText = "‚ùå Erreur de synchro";
            });
        }

        window.saveData = async () => {
            if (!user || isUpdatingFromSync) return;
            state.storeName = document.getElementById('store-name').value;
            state.storeLogo = document.getElementById('store-logo').value;
            state.storeAddress = document.getElementById('store-address').value;
            state.prefix = document.getElementById('order-prefix').value;
            state.orderNumber = parseInt(document.getElementById('order-num').value) || 0;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ticketConfig');
            await setDoc(docRef, state);
        };

        function updateUI() {
            document.getElementById('store-name').value = state.storeName || "";
            document.getElementById('store-logo').value = state.storeLogo || "";
            document.getElementById('store-address').value = state.storeAddress || "";
            document.getElementById('order-prefix').value = state.prefix || "";
            document.getElementById('order-num').value = state.orderNumber || 0;
            renderItemsList();
        }

        function renderItemsList() {
            const container = document.getElementById('items-list');
            container.innerHTML = '';
            state.items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex gap-2 items-center bg-slate-50 p-2 rounded-lg border";
                div.innerHTML = `
                    <input type="text" value="${item.name}" placeholder="Art." oninput="updateItem(${index}, 'name', this.value)" class="flex-1 p-2 border rounded-md text-sm">
                    <div class="flex items-center">
                        <input type="number" step="0.01" value="${item.priceTTC}" oninput="updateItem(${index}, 'priceTTC', parseFloat(this.value))" class="w-20 p-2 border rounded-md text-sm text-right font-bold">
                        <span class="ml-1 text-[10px] text-blue-600 font-bold">TTC</span>
                    </div>
                    <select onchange="updateItem(${index}, 'tva', this.value)" class="p-2 border rounded-md text-xs bg-white">
                        <option value="A" ${item.tva === 'A' ? 'selected' : ''}>A (20%)</option>
                        <option value="B" ${item.tva === 'B' ? 'selected' : ''}>B (10%)</option>
                        <option value="0" ${item.tva === '0' ? 'selected' : ''}>0%</option>
                    </select>
                    <button onclick="deleteItem(${index})" class="text-red-400 p-1">‚úï</button>
                `;
                container.appendChild(div);
            });
        }

        window.addItem = () => {
            state.items.push({ id: Date.now(), name: "", priceTTC: 0, tva: "A" });
            saveData();
            renderItemsList();
        };

        window.deleteItem = (idx) => {
            state.items.splice(idx, 1);
            saveData();
            renderItemsList();
        };

        window.updateItem = (idx, field, val) => {
            state.items[idx][field] = val;
            saveData();
        };

        window.switchPage = (page) => {
            document.getElementById('page-config').classList.toggle('hidden', page === 'view');
            document.getElementById('page-view').classList.toggle('hidden', page === 'config');
            document.getElementById('btn-config').className = page === 'config' ? "flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white font-bold shadow-md" : "flex-1 py-3 px-4 rounded-lg text-slate-600 font-bold";
            document.getElementById('btn-view').className = page === 'view' ? "flex-1 py-3 px-4 rounded-lg bg-blue-600 text-white font-bold shadow-md" : "flex-1 py-3 px-4 rounded-lg text-slate-600 font-bold";
            if(page === 'view') renderReceipt();
        };

        function renderReceipt() {
            const container = document.getElementById('receipt-to-print');
            const tvaMap = { A: 20, B: 10, "0": 0 };
            let totalTTC = 0;
            let totalHT = 0;
            let itemsHtml = '';

            state.items.forEach(item => {
                if (!item.name && item.priceTTC === 0) return;
                
                const rate = tvaMap[item.tva];
                // Calcul du HT √† partir du TTC : HT = TTC / (1 + Taux)
                const ht = item.priceTTC / (1 + (rate / 100));
                
                totalTTC += item.priceTTC;
                totalHT += ht;

                itemsHtml += `
                    <tr>
                        <td class="py-1 uppercase text-[9px]">${item.name || '---'}</td>
                        <td class="py-1 text-right font-bold">${item.priceTTC.toFixed(2)}</td>
                        <td class="py-1 text-right text-[8px] pl-2">${item.tva}</td>
                    </tr>
                `;
            });

            const totalTVA = totalTTC - totalHT;

            container.innerHTML = `
                ${state.storeLogo ? `<div class="flex justify-center mb-2"><img src="${state.storeLogo}" class="max-w-[30mm] h-auto object-contain"></div>` : ''}
                <div class="text-center font-bold text-sm uppercase mb-1">${state.storeName || "BOUTIQUE"}</div>
                <div class="text-center text-[8px] mb-4 whitespace-pre-line">${state.storeAddress || ""}</div>
                <div class="border-b border-black mb-2"></div>
                <div class="flex justify-between mb-2">
                    <span>${new Date().toLocaleDateString('fr-FR')}</span>
                    <span class="font-bold">${state.prefix || ""}${state.orderNumber || 0}</span>
                </div>
                <table class="w-full mb-3">
                    <tbody class="divide-y divide-dotted divide-black">${itemsHtml}</tbody>
                </table>
                <div class="border-t border-black pt-2 space-y-1">
                    <div class="flex justify-between"><span>TOTAL HT</span><span>${totalHT.toFixed(2)} ‚Ç¨</span></div>
                    <div class="flex justify-between italic text-[9px]"><span>DONT TVA</span><span>${totalTVA.toFixed(2)} ‚Ç¨</span></div>
                    <div class="flex justify-between font-bold text-sm pt-2 border-t border-black">
                        <span>TOTAL TTC</span>
                        <span class="text-base">${totalTTC.toFixed(2)} ‚Ç¨</span>
                    </div>
                </div>
                <div class="mt-8 text-center text-[8px] uppercase tracking-widest pt-4 border-t border-slate-100">
                    Merci de votre visite
                </div>
            `;
        }

        window.openPrintWindow = () => {
            renderReceipt();
            const ticketHtml = document.getElementById('receipt-to-print').outerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Impression Ticket</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
                        body { margin: 0; padding: 0; display: flex; justify-content: center; font-family: 'Courier Prime', monospace; }
                        .ticket-receipt { width: 53mm; background: white; padding: 4mm; color: black; line-height: 1.2; font-size: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        .text-right { text-align: right; }
                        .text-center { text-align: center; }
                        .font-bold { font-weight: bold; }
                        .uppercase { text-transform: uppercase; }
                        .flex { display: flex; }
                        .justify-between { justify-content: space-between; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .mb-4 { margin-bottom: 1rem; }
                        .mt-8 { margin-top: 2rem; }
                        .border-b { border-bottom: 1px solid black; }
                        .border-t { border-top: 1px solid black; }
                        img { max-width: 30mm; height: auto; }
                        .divide-y { border-bottom: 1px dotted black; }
                        .text-base { font-size: 12px; }
                        .italic { font-style: italic; }
                    </style>
                </head>
                <body onload="window.focus();">
                    ${ticketHtml}
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        init();
    </script>
</body>
</html>